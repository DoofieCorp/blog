<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>Azure bug bounty Root to storage account administrator | Rants of a software engineer</title>

  
  <link rel="stylesheet" href="/css/poole.css">
  <link rel="stylesheet" href="/css/hyde.css">
  <link rel="stylesheet" href="/css/poole-overrides.css">
  <link rel="stylesheet" href="/css/hyde-overrides.css">
  <link rel="stylesheet" href="/css/hyde-x.css">
  <link rel="stylesheet" href="/css/highlight/sunburst.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
  

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/touch-icon-144-precomposed.png">
  <link href="/favicon.png" rel="icon">

  
  
  
  

  <meta name="description" content="Details how its possible to become an azure Storage account administrator from having root access on a virtual machine">
  <meta name="keywords" content="Security,Cloud,Infrastructure,Azure,Red Hat,RHEL,AWS">
  
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-33060296-1', 'auto');
    ga('send', 'pageview');
  </script>
  
</head>
<body>
<div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      
        <img src="https://www.gravatar.com/avatar/fda265e7910b191285e57e9e303963eb?s=200"
             alt="gravatar" title="Ian Duffy">
      
      <h1>Ian Duffy</h1>
      <p class="lead">Rants of a software engineer</p>
    </div>

    <ul class="sidebar-nav">
      
    </ul>

    <ul class="sidebar-nav">
      <li class="sidebar-nav-item">
      <a href="http://github.com/imduffy15"><i class="fa fa-github-square fa-3x"></i></a>
      
      
      <a href="https://ie.linkedin.com/in/imduffy15"><i class="fa fa-linkedin-square fa-3x"></i></a>
      
      
      
      <a href="https://www.youtube.com/channel/UCoGs2iiOIGrfXofp-3g-Qqg"><i class="fa fa-youtube-square fa-3x"></i></a>
      
      </li>
    </ul>

    
  </div>
</div>


<div class="content container">
  <div class="post">
    <h1 class="post-title">Azure bug bounty Root to storage account administrator</h1>
    <span class="post-date">Nov 27, 2016 &middot; 2 minute read &middot; <a href="http://ianduffy.ie/blog/2016/11/27/azure-bug-bounty-root-to-storage-account-administrator/#disqus_thread">Comments</a>
    
    <br/>
    <a class="label" href="http://ianduffy.ie/categories/cloud">Cloud</a><a class="label" href="http://ianduffy.ie/categories/security">Security</a><a class="label" href="http://ianduffy.ie/categories/azure">Azure</a>
    </span>
    <p>In my previous blog post <a href="http://ianduffy.ie/blog/2016/11/26/azure-bug-bounty-pwning-red-hat-enterprise-linux/">Azure bug bounty Pwning Red Hat Enterprise Linux</a> I detailed how it was possible to get administrative access to the Red Hat Update Infrastructure consumed by <a href="https://www.redhat.com/en/technologies/linux-platforms/enterprise-linux">Red Hat Enterprise Linux</a> virtual machines booted from the <a href="https://azure.microsoft.com">Microsoft Azure</a> Marketplace image. In theory, if exploited one could have gained root access to all virtual machines consuming the repositories by releasing an updated version of a common package and waiting for virtual machines to execute <code>yum update</code>.</p>

<p>As an attacker, this would have granted access to every piece of data on the compromised virtual machines. Sadly, the attack vector is actually much more widespread than this. Given some poor implementation within the mandatory <a href="https://azure.microsoft.com">Microsoft Azure</a> Linux Agent (WaLinuxAgent) one is able to obtain the administrator API keys to the storage account used by the virtual machine for debug log shipping purposes, at the time of research this storage account defaulted to one shared by multiple virtual machines.</p>

<p>At the time of research, the <a href="https://www.redhat.com/en/technologies/linux-platforms/enterprise-linux">Red Hat Enterprise Linux</a> image available on the <a href="https://azure.microsoft.com">Microsoft Azure</a> Marketplace came with WaLinuxAgent 2.0.16. When a virtual machine was created with the &ldquo;Linux diagnostic extension&rdquo; enabled the API key for access to the specified storage account was written to <code>/var/lib/waagent/Microsoft.OSTCExtensions.LinuxDiagnostic-2.3.9007/xmlCfg.xml</code>.</p>

<p>Once acquired one can simply use the <a href="https://github.com/Azure/azure-xplat-cli">Azure Xplat-CLI</a> to interact the storage account:</p>

<pre><code>export AZURE_STORAGE_ACCOUNT=&quot;storage_account_name_as_per_xmlcfg&quot;
export AZURE_STORAGE_ACCESS_KEY=&quot;storage_account_access_key_as_per_xmlcfg&quot;
azure storage container list # acquire some container name
azure storage blob list # provide the container name
# Copy, download, upload, delete any blobs available across any containers you can access.
</code></pre>

<p>If the storage account was used by multiple virtual machines there is potential to download their virtual hard disks.</p>

  </div>
  <div id="disqus_thread"></div>
</div>


<script type="text/javascript">
var disqus_shortname = "ianduffy";
(function () {
    var s = document.createElement('script'); s.async = true;
    s.type = 'text/javascript';
    s.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
}());
</script>



<script type="text/javascript">
    var disqus_shortname = "ianduffy";
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.4.0/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
</body>
</html>

