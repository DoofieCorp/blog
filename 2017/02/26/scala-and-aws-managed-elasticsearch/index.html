<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>Scala and AWS managed ElasticSearch | Rants of a software engineer</title>

  
  <link rel="stylesheet" href="/css/poole.css">
  <link rel="stylesheet" href="/css/hyde.css">
  <link rel="stylesheet" href="/css/poole-overrides.css">
  <link rel="stylesheet" href="/css/hyde-overrides.css">
  <link rel="stylesheet" href="/css/hyde-x.css">
  <link rel="stylesheet" href="/css/highlight/sunburst.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
  

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/touch-icon-144-precomposed.png">
  <link href="/favicon.png" rel="icon">

  
  
  
  

  <meta name="description" content="Details how to use Elastic4s with AWS managed ElasticSearch">
  <meta name="keywords" content="scala,aws,elasticsearch,iam,authentication,signing,elastic4s">
  
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-33060296-1', 'auto');
    ga('send', 'pageview');
  </script>
  
</head>
<body>
<div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      
      <h1>Ian Duffy</h1>
      <p class="lead">Rants of a software engineer</p>
    </div>

    <ul class="sidebar-nav">
      
    </ul>

    <ul class="sidebar-nav">
      <li class="sidebar-nav-item">
      <a href="http://github.com/imduffy15"><i class="fa fa-github-square fa-3x"></i></a>
      
      
      <a href="https://ie.linkedin.com/in/imduffy15"><i class="fa fa-linkedin-square fa-3x"></i></a>
      
      
      
      <a href="https://www.youtube.com/channel/UCoGs2iiOIGrfXofp-3g-Qqg"><i class="fa fa-youtube-square fa-3x"></i></a>
      
      </li>
    </ul>

    
  </div>
</div>


<div class="content container">
  <div class="post">
    <h1 class="post-title">Scala and AWS managed ElasticSearch</h1>
    <p><a href="https://aws.amazon.com/">AWS</a> offer a <a href="https://aws.amazon.com/elasticsearch-service/">managed ElasticSearch service</a>. It exposes an HTTP endpoint for interacting with ElasticSearch and requires authentication via <a href="https://aws.amazon.com/documentation/iam/">AWS Identity Access Management</a>.</p>
<p><a href="https://github.com/sksamuel/elastic4s">Elastic4s</a> offers a neat DSL and Scala client for ElasticSearch. This post details how to use it with <a href="https://aws.amazon.com/">AWS&rsquo;s</a> <a href="https://aws.amazon.com/elasticsearch-service/">managed ElasticSearch service</a>.</p>
<h2 id="creating-a-request-signer">Creating a request signer</h2>
<p>Using the <a href="https://github.com/inreachventures/aws-signing-request-interceptor">aws-signing-request-interceptor</a> library its easy to create an <a href="https://hc.apache.org/httpcomponents-core-ga/httpcore/apidocs/org/apache/http/HttpRequestInterceptor.html">HttpRequestInterceptor</a> which can be later added to the HttpClient used by <a href="https://github.com/sksamuel/elastic4s">Elastic4s</a> for making the calls to ElasticSearch</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-scala" data-lang="scala"><span class="k">private</span> <span class="k">def</span> <span class="n">createAwsSigner</span><span class="o">(</span><span class="n">config</span><span class="k">:</span> <span class="kt">Config</span><span class="o">)</span><span class="k">:</span> <span class="kt">AWSSigner</span> <span class="o">=</span> <span class="o">{</span>
  <span class="k">import</span> <span class="nn">com.gilt.gfc.guava.GuavaConversions._</span>

  <span class="k">val</span> <span class="n">awsCredentialsProvider</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">DefaultAWSCredentialsProviderChain</span>
  <span class="k">val</span> <span class="n">service</span> <span class="k">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getString</span><span class="o">(</span><span class="s">&#34;service&#34;</span><span class="o">)</span>
  <span class="k">val</span> <span class="n">region</span> <span class="k">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getString</span><span class="o">(</span><span class="s">&#34;region&#34;</span><span class="o">)</span>
  <span class="k">val</span> <span class="n">clock</span><span class="k">:</span> <span class="kt">Supplier</span><span class="o">[</span><span class="kt">LocalDateTime</span><span class="o">]</span> <span class="k">=</span> <span class="o">()</span> <span class="k">=&gt;</span> <span class="nc">LocalDateTime</span><span class="o">.</span><span class="n">now</span><span class="o">(</span><span class="nc">ZoneId</span><span class="o">.</span><span class="n">of</span><span class="o">(</span><span class="s">&#34;UTC&#34;</span><span class="o">))</span>
  <span class="k">new</span> <span class="nc">AWSSigner</span><span class="o">(</span><span class="n">awsCredentialsProvider</span><span class="o">,</span> <span class="n">region</span><span class="o">,</span> <span class="n">service</span><span class="o">,</span> <span class="n">clock</span><span class="o">)</span>
<span class="o">}</span>
</code></pre></div><h2 id="creating-an-http-client-and-intercepting-the-requests">Creating an HTTP Client and intercepting the requests</h2>
<p>The ElasticSearch <a href="https://github.com/elastic/elasticsearch/blob/master/client/rest/src/main/java/org/elasticsearch/client/RestClientBuilder.java#L230">RestClientBuilder</a> allows for registering a callback to modify the customise the <a href="http://hc.apache.org/httpcomponents-asyncclient-dev/httpasyncclient/apidocs/org/apache/http/impl/nio/client/HttpAsyncClientBuilder.html#addInterceptorLast(org.apache.http.HttpResponseInterceptor)">HttpAsyncClientBuilder</a> enabling registering the interceptor to sign the requests.</p>
<p>The callback can be created by implementing the HttpClientConfigCallback interface as follows:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-scala" data-lang="scala"><span class="k">private</span> <span class="k">val</span> <span class="n">esConfig</span> <span class="k">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getConfig</span><span class="o">(</span><span class="s">&#34;elasticsearch&#34;</span><span class="o">)</span>

<span class="k">private</span> <span class="k">class</span> <span class="nc">AWSSignerInteceptor</span> <span class="k">extends</span> <span class="nc">HttpClientConfigCallback</span> <span class="o">{</span>
  <span class="k">override</span> <span class="k">def</span> <span class="n">customizeHttpClient</span><span class="o">(</span><span class="n">httpClientBuilder</span><span class="k">:</span> <span class="kt">HttpAsyncClientBuilder</span><span class="o">)</span><span class="k">:</span> <span class="kt">HttpAsyncClientBuilder</span> <span class="o">=</span> <span class="o">{</span>
    <span class="n">httpClientBuilder</span><span class="o">.</span><span class="n">addInterceptorLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">AWSSigningRequestInterceptor</span><span class="o">(</span><span class="n">createAwsSigner</span><span class="o">(</span><span class="n">esConfig</span><span class="o">)))</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><p>Finally, an <a href="https://github.com/sksamuel/elastic4s">Elastic4s</a> client can be created with the interceptor registered:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-scala" data-lang="scala"><span class="k">private</span> <span class="k">def</span> <span class="n">createEsHttpClient</span><span class="o">(</span><span class="n">config</span><span class="k">:</span> <span class="kt">Config</span><span class="o">)</span><span class="k">:</span> <span class="kt">HttpClient</span> <span class="o">=</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">hosts</span> <span class="k">=</span> <span class="nc">ElasticsearchClientUri</span><span class="o">(</span><span class="n">config</span><span class="o">.</span><span class="n">getString</span><span class="o">(</span><span class="s">&#34;uri&#34;</span><span class="o">)).</span><span class="n">hosts</span><span class="o">.</span><span class="n">map</span> <span class="o">{</span>
    <span class="k">case</span> <span class="o">(</span><span class="n">host</span><span class="o">,</span> <span class="n">port</span><span class="o">)</span> <span class="k">=&gt;</span>
      <span class="k">new</span> <span class="nc">HttpHost</span><span class="o">(</span><span class="n">host</span><span class="o">,</span> <span class="n">port</span><span class="o">,</span> <span class="s">&#34;http&#34;</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="o">(</span><span class="s">s&#34;Creating HTTP client on </span><span class="si">${</span><span class="n">hosts</span><span class="o">.</span><span class="n">mkString</span><span class="o">(</span><span class="s">&#34;,&#34;</span><span class="o">)</span><span class="si">}</span><span class="s">&#34;</span><span class="o">)</span>

  <span class="k">val</span> <span class="n">client</span> <span class="k">=</span> <span class="nc">RestClient</span><span class="o">.</span><span class="n">builder</span><span class="o">(</span><span class="n">hosts</span><span class="k">:</span> <span class="k">_</span><span class="kt">*</span><span class="o">)</span>
    <span class="o">.</span><span class="n">setHttpClientConfigCallback</span><span class="o">(</span><span class="k">new</span> <span class="nc">AWSSignerInteceptor</span><span class="o">)</span>
    <span class="o">.</span><span class="n">build</span><span class="o">()</span>
  <span class="nc">HttpClient</span><span class="o">.</span><span class="n">fromRestClient</span><span class="o">(</span><span class="n">client</span><span class="o">)</span>
<span class="o">}</span>
</code></pre></div><p>Full Example on <a href="https://github.com/imduffy15/scala-aws-hosted-es/blob/master/src/main/scala/Run.scala">GitHub</a></p>

  </div>
</div>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.4.0/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
</body>
</html>

