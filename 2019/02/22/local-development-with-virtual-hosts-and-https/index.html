<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>Local development with virtual hosts and HTTPS | Rants of a software engineer</title>

  
  <link rel="stylesheet" href="/css/poole.css">
  <link rel="stylesheet" href="/css/hyde.css">
  <link rel="stylesheet" href="/css/poole-overrides.css">
  <link rel="stylesheet" href="/css/hyde-overrides.css">
  <link rel="stylesheet" href="/css/hyde-x.css">
  <link rel="stylesheet" href="/css/highlight/sunburst.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
  

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/touch-icon-144-precomposed.png">
  <link href="/favicon.png" rel="icon">

  <meta name="description" content="Using docker to provide virtual hosts and HTTPS to your local applications">
  <meta name="keywords" content="Docker,Nginx,Development,Vhosts,DNS,LetsEncrypt,SSL,HTTPS,Web,OSX,Mac,Dig">
  
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-33060296-1', 'auto');
    ga('send', 'pageview');
  </script>
  
</head>
<body>
<div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      
      <h1>Ian Duffy</h1>
      <p class="lead">Rants of a software engineer</p>
    </div>

    <ul class="sidebar-nav">
      
    </ul>

    <ul class="sidebar-nav">
      <li class="sidebar-nav-item">
      <a href="http://github.com/imduffy15"><i class="fa fa-github-square fa-3x"></i></a>
      
      
      <a href="https://ie.linkedin.com/in/imduffy15"><i class="fa fa-linkedin-square fa-3x"></i></a>
      
      
      
      <a href="https://www.youtube.com/channel/UCoGs2iiOIGrfXofp-3g-Qqg"><i class="fa fa-youtube-square fa-3x"></i></a>
      
      </li>
    </ul>

    
  </div>
</div>


<div class="content container">
  <div class="post">
    <h1 class="post-title">Local development with virtual hosts and HTTPS</h1>
    <center>
<p><img src="/images/local-development-with-virtual-hosts-and-https/diagram.png" alt=""></p>
</center>
<p>When doing development locally it might be necessary to access the application(s) using a virtual host (vhost) and/or HTTPS. This post describes an approach to achieving this on OSX using Docker, which avoids creating a large mess on your computer.</p>
<h2 id="domain-name-systems-dns">Domain Name Systems (DNS)</h2>
<p>Domain Name Systems (DNS) are often referred to as the phonebook of the internet. People access information online through domain names, like ‘amazon.com’ or ‘rte.ie’. DNS is responsible for translating a domain name to an IP address.</p>
<p>When an HTTP resource is accessed using DNS, an additional header containing the domain name is provided to the HTTP server. The HTTP server uses this for routing the request to the correct vhost.</p>
<p>In order to have functioning vhosts, DNS is required. <a href="http://www.thekelleys.org.uk/dnsmasq/doc.html">Dnsmasq</a> is a popular DNS server, it can be configured to resolve a set of specified domains to a specified IP address. Using docker a dnsmasq server can easily be created:</p>
<pre tabindex="0"><code>$ docker run -it -p 53:53/udp --cap-add=NET_ADMIN andyshinn/dnsmasq:latest --log-queries --log-facility=- --address=/dev.ianduffy.ie/127.0.0.1
</code></pre><p>The provided command line arguments instruct dnsmasq to resolve all requests for dev.ianduffy.ie and *.dev.ianduffy.ie to 127.0.0.1. Using dig - a DNS lookup utility this configuration can be validated:</p>
<pre tabindex="0"><code>$ dig @127.0.0.1 dev.ianduffy.ie +short
127.0.0.1
</code></pre><p>Additionally, all wildcards of dev.ianduffy.ie also resolve:</p>
<pre tabindex="0"><code>$ dig @127.0.0.1 random-string.dev.ianduffy.ie +short
127.0.0.1
</code></pre><p>While this works, the OSX is not configured to use this DNS server for it’s lookups so attempting to resolve dev.ianduffy.ie in the browser will fail. It&rsquo;s possible to specify nameservers for a specific domain name, this can be achieved by creating a file within /etc/resolver with a filename that matches the domain.</p>
<p>For example, if /etc/resolver/dev.ianduffy.ie is created with the following contents:</p>
<pre tabindex="0"><code>nameserver 127.0.0.1
</code></pre><p>Now all queries to dev.ianduffy.ie will be resolved by doing a lookup against the DNS server at 127.0.0.1.</p>
<h2 id="http">HTTP</h2>
<p>A HTTP server will be required for routing the requests based on a vhost and supplying HTTPS. Nginx is a good fit for this, even-more-so as <a href="https://www.linkedin.com/in/jason-wilder-94549/">Jason Wilder</a> from Microsoft has created a  <a href="https://github.com/jwilder/nginx-proxy">container image</a> that exposes the nginx reverse proxy functionality via environment variables.</p>
<p><a href="https://github.com/jwilder/nginx-proxy">nginx-proxy</a> can be started using the following:</p>
<pre tabindex="0"><code>$ docker run -it -p 80:80 -v /var/run/docker.sock:/tmp/docker.sock:ro jwilder/nginx-proxy
</code></pre><p><a href="https://github.com/jwilder/nginx-proxy">nginx-proxy</a> will look for <code>VIRTUAL_HOST</code> environment variables on other docker containers and route to them accordingly. To demonstrate this, a container running <a href="https://httpbin.org">httpbin</a> which provides data for debugging HTTP requests can be created, with a VIRTUAL_HOST environment variable specified.</p>
<pre tabindex="0"><code>$ docker run -e VIRTUAL_HOST=httpbin.dev.ianduffy.ie kennethreitz/httpbin
</code></pre><p>This service can now be accessed via httpbin.dev.ianduffy.ie. Alternatively, if you do not have the dnsmasq service from earlier running, the service can be accessed by passing the header &ldquo;host&rdquo; with value &ldquo;httpbin.dev.ianduffy.ie&rdquo;. This can be tested with an HTTP client like <a href="https://curl.haxx.se/">curl</a></p>
<pre tabindex="0"><code>$ curl http://httpbin.dev.ianduffy.ie/headers
{
  &#34;headers&#34;: {
    &#34;Accept&#34;: &#34;*/*&#34;,
    &#34;Connection&#34;: &#34;close&#34;,
    &#34;Host&#34;: &#34;httpbin.dev.ianduffy.ie&#34;,
    &#34;User-Agent&#34;: &#34;curl/7.54.0&#34;
  }
}
</code></pre><pre tabindex="0"><code>$ curl -H &#34;host: httpbin.dev.ianduffy.ie&#34; http://127.0.0.1/headers
{
  &#34;headers&#34;: {
    &#34;Accept&#34;: &#34;*/*&#34;,
    &#34;Connection&#34;: &#34;close&#34;,
    &#34;Host&#34;: &#34;httpbin.dev.ianduffy.ie&#34;,
    &#34;User-Agent&#34;: &#34;curl/7.54.0&#34;
  }
}
</code></pre><h2 id="https">HTTPS</h2>
<p>In some scenarios, HTTPS might be required. <a href="https://github.com/FiloSottile/mkcert">mkcert</a> provides locally trusted SSL certificates and automatically OSX, Linux, and Windows system stores along with Firefox, Chrome and Java.</p>
<p>With <a href="https://github.com/FiloSottile/mkcert">mkcert</a> installed, certificates can be generated with the following command:</p>
<pre tabindex="0"><code>$ mkdir certs
$ mkcert -cert-file certs/dev.ianduffy.ie.crt -key-file certs/dev.ianduffy.ie.key -install dev.ianduffy.ie *.dev.ianduffy.ie
</code></pre><p>By mounting these certificates, as a volume on a container running nginx-proxy HTTPS will be enabled.</p>
<pre tabindex="0"><code>$ docker run -it -p 80:80 -p 443:443 -v $(pwd)/certs:/etc/nginx/certs -v /var/run/docker.sock:/tmp/docker.sock:ro jwilder/nginx-proxy
</code></pre><p>Executing <code>curl</code> to <a href="https://httpbin.dev.ianduffy.ie">https://httpbin.dev.ianduffy.ie</a> will now respond successfully. Additionally, the <code>-v</code> flag can be specified to tell curl to be verbose and it will display information about the SSL certificate.</p>
<pre tabindex="0"><code>$ curl -v https://httpbin.dev.ianduffy.ie/headers
</code></pre><h2 id="placing-a-vhost-in-front-of-a-local-application">Placing a vhost in front of a local application</h2>
<p>Most developers will want to run their application on the host and continue with the standard development workflow. To accommodate for this, a container that forwards traffic to a host port can be created.</p>
<p><a href="http://www.dest-unreach.org/socat/doc/README">socat</a> is perfect for this use case, it enables us to specify a source IP address and port and a destination IP address and port. In the example below, all traffic for test.dev.ianduffy.ie will be forwarded to the docker host on port 9000.</p>
<pre tabindex="0"><code>$ docker run -it --expose 80 -e VIRTUAL_HOST=test.dev.ianduffy.ie alpine/socat tcp-listen:80,fork,reuseaddr tcp-connect:host.docker.internal:9000
</code></pre><h2 id="bring-it-all-together-with-docker-compose">Bring it all together with docker-compose</h2>
<p>All of the containers described above can be brought together in a single docker compose file. This provides ease of bringing the system up with a single command.</p>
<pre tabindex="0"><code>nginx-proxy:
  container_name: nginx-proxy
  image: jwilder/nginx-proxy
  ports:
    - 80:80
    - 443:443
  volumes:
    - /var/run/docker.sock:/tmp/docker.sock:ro
    - ./certs:/etc/nginx/certs:ro
dnsmasq:
  container_name: dnsmasq
  image: andyshinn/dnsmasq:latest
  command: --log-queries --log-facility=- --address=/dev.ianduffy.ie/127.0.0.1
  ports:
    - 53:53
    - 53:53/udp
  cap_add:
    - NET_ADMIN
socat:
  image: alpine/socat
  command: tcp-listen:80,fork,reuseaddr tcp-connect:host.docker.internal:9000
  environment:
    - VIRTUAL_HOST=dev.ianduffy.ie
    - VIRTUAL_PORT=80
  expose:
    - 80
</code></pre><p>This enables VHosts and HTTPS for applications running on the host without creating too much of a mess as its all contained within Docker.</p>

  </div>
</div>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.4.0/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
</body>
</html>

